<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Board Game Card Prototyping Tool</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Vue 3 (Global) -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- html2canvas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <style>
        /* é˜²æ­¢é¸å–æ–‡å­—å¹²æ“¾æ‹–æ›³ */
        .no-select {
            user-select: none;
            -webkit-user-select: none;
        }
        
        /* éš±è—æ»¾å‹•æ¢ä½†ä¿æŒåŠŸèƒ½ */
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* å¡ç‰‡ç•«å¸ƒåŸºç¤æ¨£å¼ (è¢å¹•é¡¯ç¤ºç”¨) */
        .card-canvas {
            background-color: white;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            overflow: hidden;
            position: relative;
            isolation: isolate; /* Create new stacking context */
            /* å¯¬é«˜å°‡ç”± JS å‹•æ…‹æ§åˆ¶ */
            transition: transform 0.2s, width 0.2s, height 0.2s;
        }

        /* å…ƒç´ é¸å–æ™‚çš„é‚Šæ¡† */
        .element-selected {
            outline: 2px dashed #3b82f6; /* Blue-500 */
            z-index: 100 !important;
        }

        /* --- åˆ—å°é è¦½èˆ‡è¼¸å‡ºé€šç”¨æ¨£å¼ --- */
        /* å®šç¾©å¡ç‰‡åœ¨åˆ—å°èˆ‡é è¦½æ™‚çš„ç‰©ç†å°ºå¯¸èˆ‡å®šä½åŸºæº– */
        .print-card {
            /* å¯¬é«˜å°‡ç”± JS å‹•æ…‹æ§åˆ¶ */
            /* border: 1px solid #ccc;  Moved to inline style logic */
            position: relative; /* é—œéµï¼šè®“å…§éƒ¨ absolute å…ƒç´ ç›¸å°æ–¼å¡ç‰‡å®šä½ */
            isolation: isolate; /* Create new stacking context */
            /* overflow: hidden; Removed to allow rotated content to show fully if needed, though inner wrapper has overflow:hidden */
            box-sizing: border-box; /* ç¢ºä¿é‚Šæ¡†ä¸å½±éŸ¿å°ºå¯¸è¨ˆç®— */
        }

        .print-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 2mm;
            justify-content: center;
            align-content: start;
        }

        /* --- åˆ—å°å°ˆç”¨æ¨£å¼ (æŒ‰ä¸‹ Ctrl+P æ™‚ç”Ÿæ•ˆ) --- */
        @media print {
            @page {
                size: A4;
                margin: 5mm; /* Reduced margin to fit 3x3 big cards with gap */
            }
            body {
                background: white;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
            /* éš±è—æ‰€æœ‰ UI */
            .no-print, nav, .sidebar, .toolbar, .inspector {
                display: none !important;
            }
            /* é¡¯ç¤ºåˆ—å°å€åŸŸ */
            .print-only {
                display: block !important;
            }
            
            /* åˆ—å°æ™‚çš„å¾®èª¿ */
            .print-card {
                page-break-inside: avoid;
                /* border: 1px solid #ccc; Handled by inline styles now */
            }

            .print-page {
                box-shadow: none !important;
                margin: 0 !important;
                padding: 0 !important;
                width: auto !important;
                min-height: auto !important;
                break-after: page; /* å¼·åˆ¶åˆ†é  */
            }
        }

        .print-only {
            display: none;
        }
    </style>
</head>
<body class="bg-gray-100 h-screen flex flex-col font-sans text-gray-800">

    <div id="app" class="h-full flex flex-col">
        
        <!-- é ‚éƒ¨å°èˆªæ¬„ (No Print) -->
        <nav class="bg-gray-800 text-white p-3 flex flex-nowrap justify-between items-center no-print shadow-md z-50 gap-2 sticky top-0 h-14">
            <!-- Left: Logo & Hamburger -->
            <div class="flex items-center gap-4 shrink-0">
                <div class="flex items-center gap-3">
                    <!-- Mobile Hamburger Menu -->
                    <button class="md:hidden text-white focus:outline-none" @click="showLeftSidebar = !showLeftSidebar">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
                    </button>
                    
                    <div class="flex items-baseline gap-2">
                        <h1 class="text-xl font-bold">cMVP</h1>
                        <span class="text-xs text-gray-500 font-mono hidden md:inline">v1.4.2</span>
                        <span v-if="currentProject" class="text-xs text-gray-400 bg-gray-700 px-2 py-0.5 rounded-full truncate max-w-[100px] md:max-w-none hidden sm:inline">
                            {{ currentProject.name }}
                        </span>
                    </div>
                </div>
            </div>

            <!-- Center: View Switcher (Scrollable on mobile) -->
            <div class="flex gap-2 text-sm overflow-x-auto pb-1 md:pb-0 px-2 flex-1 justify-center md:justify-start scrollbar-hide">
                <button @click="currentView = 'projects'" :class="{'bg-gray-600': currentView === 'projects'}" class="whitespace-nowrap px-3 py-1 rounded hover:bg-gray-700 transition flex items-center gap-1 shrink-0">
                    <span>ğŸ“‚</span> <span class="hidden md:inline">å°ˆæ¡ˆåˆ—è¡¨</span>
                </button>
                <button v-if="currentProject" @click="currentView = 'editor'" :class="{'bg-gray-600': currentView === 'editor'}" class="whitespace-nowrap px-3 py-1 rounded hover:bg-gray-700 transition flex items-center gap-1 shrink-0">
                    <span>âœï¸</span> <span class="hidden md:inline">å¡ç‰‡ç·¨è¼¯</span>
                </button>
                <button v-if="currentProject" @click="currentView = 'print'" :class="{'bg-gray-600': currentView === 'print'}" class="whitespace-nowrap px-3 py-1 rounded hover:bg-gray-700 transition flex items-center gap-1 shrink-0">
                    <span>ğŸ–¨ï¸</span> <span class="hidden md:inline">åŒ¯å‡º</span>
                </button>
            </div>

            <!-- Right: Actions (Desktop: Buttons, Mobile: Kebab Menu) -->
            <div class="flex gap-2 text-sm items-center relative shrink-0">
                <!-- Desktop Buttons -->
                <div class="hidden md:flex gap-2">
                    <button @click="saveData" class="flex items-center gap-1 bg-green-600 px-3 py-1 rounded hover:bg-green-700">
                        <span>ğŸ’¾</span> <span>å„²å­˜</span>
                    </button>
                    <button @click="exportData" class="flex items-center gap-1 bg-blue-600 px-3 py-1 rounded hover:bg-blue-700">
                        <span>â¬‡ï¸</span> <span>åŒ¯å‡º JSON</span>
                    </button>
                    <label class="flex items-center gap-1 bg-yellow-600 px-3 py-1 rounded hover:bg-yellow-700 cursor-pointer">
                        <span>â¬†ï¸</span> <span>åŒ¯å…¥ JSON</span>
                        <input type="file" @change="importData" class="hidden" accept=".json">
                    </label>
                </div>

                <!-- Mobile Kebab Menu Button -->
                <button class="md:hidden text-white focus:outline-none p-1" @click="showMobileMenu = !showMobileMenu">
                    <span class="text-xl leading-none">â‹®</span>
                </button>

                <!-- Mobile Menu Dropdown -->
                <div v-if="showMobileMenu" class="absolute top-full right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 z-50 md:hidden border border-gray-200">
                    <button @click="saveData(); showMobileMenu = false" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                        ğŸ’¾ å„²å­˜
                    </button>
                    <button @click="exportData(); showMobileMenu = false" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">
                        â¬‡ï¸ åŒ¯å‡º JSON
                    </button>
                    <label class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 cursor-pointer">
                        â¬†ï¸ åŒ¯å…¥ JSON
                        <input type="file" @change="importData" class="hidden" accept=".json">
                    </label>
                </div>
                
                <!-- Mobile Menu Backdrop -->
                <div v-if="showMobileMenu" class="fixed inset-0 z-40 bg-transparent" @click="showMobileMenu = false"></div>
            </div>
        </nav>

        <!-- 1. å°ˆæ¡ˆåˆ—è¡¨è¦–åœ– -->
        <div v-if="currentView === 'projects'" class="flex-1 p-10 overflow-auto no-print">
            <div class="max-w-4xl mx-auto">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold">æˆ‘çš„å°ˆæ¡ˆ</h2>
                    <button @click="createProject" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600 shadow">â• æ–°å»ºå°ˆæ¡ˆ</button>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div v-for="proj in projects" :key="proj.id" class="bg-white p-6 rounded-lg shadow hover:shadow-lg transition border border-gray-200">
                        <div class="flex justify-between items-start mb-4">
                            <h3 class="text-xl font-bold text-gray-800">{{ proj.name }}</h3>
                            <button @click="deleteProject(proj.id)" class="text-red-400 hover:text-red-600">ğŸ—‘ï¸</button>
                        </div>
                        <p class="text-gray-500 mb-4 text-sm">å¡ç‰‡æ•¸é‡: {{ proj.cards.length }} | è‡ªè¨‚ç‰ˆå‹: {{ proj.localTypes.length }}</p>
                        <div class="flex gap-2">
                            <button @click="openProject(proj.id)" class="flex-1 bg-gray-100 text-gray-700 py-2 rounded hover:bg-gray-200">é–‹å•Ÿå°ˆæ¡ˆ</button>
                        </div>
                    </div>
                </div>

                <!-- å…¨åŸŸç‰ˆå‹åº«ç®¡ç† (Desktop: In-flow, Mobile: Hidden/In Drawer) -->
                <div class="mt-12 border-t pt-8 hidden md:block">
                    <h2 class="text-xl font-bold mb-4">ğŸŒ å…¨åŸŸç‰ˆå‹åº« (Global Library)</h2>
                    <div class="bg-white p-4 rounded shadow overflow-auto">
                        <table class="w-full text-left">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="p-2">ç‰ˆå‹åç¨±</th>
                                    <th class="p-2">å°ºå¯¸</th>
                                    <th class="p-2">å°ˆæ¡ˆ</th>
                                    <th class="p-2">å…ƒç´ æ•¸</th>
                                    <th class="p-2 text-right">æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="(type, index) in globalLibrary" :key="type.id" class="border-b hover:bg-gray-50 transition" @dblclick="startTypeRenaming(type)">
                                    <td class="p-2">
                                        <span v-if="renamingTypeId !== type.id" class="select-none">{{ type.name }}</span>
                                        <input 
                                            v-else 
                                            v-model="type.name" 
                                            @blur="finishTypeRenaming" 
                                            @keydown.enter="finishTypeRenaming"
                                            @click.stop
                                            ref="typeNameInput"
                                            class="w-32 border rounded px-1 py-0.5 text-sm font-bold text-gray-700"
                                        >
                                    </td>
                                    <td class="p-2 text-sm text-gray-500">{{ type.width || 63 }}x{{ type.height || 88 }}mm</td>
                                    <td class="p-2 text-sm text-gray-500">{{ type.sourceProject || '-' }}</td>
                                    <td class="p-2">{{ type.elements.length }}</td>
                                    <td class="p-2 text-right">
                                        <button @click="deleteGlobalType(index)" class="text-red-500 hover:underline">åˆªé™¤</button>
                                    </td>
                                </tr>
                                <tr v-if="globalLibrary.length === 0">
                                    <td colspan="5" class="p-4 text-center text-gray-400">å°šç„¡å„²å­˜çš„ç‰ˆå‹</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Mobile Project Sidebar (Global Library) -->
        <div v-if="currentView === 'projects'" 
             class="fixed inset-y-0 left-0 w-80 max-w-full bg-white border-r flex flex-col z-[2000] transform transition-transform duration-300 md:hidden"
             :class="showLeftSidebar ? 'translate-x-0 shadow-2xl' : '-translate-x-full'">
            
            <div class="flex items-center justify-between p-2 border-b bg-gray-50">
                <span class="font-bold text-gray-700 ml-2">å…¨åŸŸç‰ˆå‹åº«</span>
                <button class="p-2 text-gray-500 hover:text-gray-800 bg-white rounded-full shadow" @click="showLeftSidebar = false">âœ•</button>
            </div>

            <div class="flex-1 overflow-y-auto p-4">
                 <div class="space-y-4">
                    <div v-for="(type, index) in globalLibrary" :key="type.id" class="bg-white border rounded p-3 shadow-sm relative">
                        <div class="flex justify-between items-start mb-1">
                            <h4 class="font-bold text-gray-800">{{ type.name }}</h4>
                            <button @click="deleteGlobalType(index)" class="text-red-400">ğŸ—‘ï¸</button>
                        </div>
                        <div class="text-xs text-gray-500 mb-2">
                             {{ type.width || 63 }}x{{ type.height || 88 }}mm â€¢ {{ type.elements.length }} å…ƒç´ <br>
                             ä¾†æº: {{ type.sourceProject || '-' }}
                        </div>
                    </div>
                    <div v-if="globalLibrary.length === 0" class="text-center text-gray-400 py-4">å°šç„¡å„²å­˜çš„ç‰ˆå‹</div>
                 </div>
            </div>
        </div>

        <!-- 2. ç·¨è¼¯å™¨è¦–åœ– (Workspace) -->
        <div v-if="currentView === 'editor' && currentProject" class="flex flex-col md:flex-row flex-1 overflow-hidden no-print relative">
            
            <!-- Mobile Backdrop for Left Sidebar -->
            <div v-if="showLeftSidebar" class="fixed inset-0 bg-black/50 z-[1990] md:hidden transition-opacity" @click="showLeftSidebar = false"></div>

            <!-- å·¦å´ï¼šå´é‚Šæ¬„ (å¡ç‰‡/ç‰ˆå‹) -->
            <div class="fixed inset-y-0 left-0 w-80 max-w-full bg-white border-r flex flex-col z-[2000] transform transition-transform duration-300 md:relative md:w-64 md:translate-x-0"
                 :class="showLeftSidebar ? 'translate-x-0 shadow-2xl' : '-translate-x-full md:shadow-none'">
                
                <!-- Mobile Header with Close Button -->
                <div class="flex items-center justify-between p-2 border-b md:hidden bg-gray-50">
                    <span class="font-bold text-gray-700 ml-2">é¸å–®</span>
                    <button class="p-2 text-gray-500 hover:text-gray-800 bg-white rounded-full shadow" @click="showLeftSidebar = false">âœ•</button>
                </div>

                <!-- Tab Switcher -->
                <div class="flex border-b text-sm">
                    <button 
                        @click="sidebarTab = 'cards'" 
                        :class="{'bg-white text-blue-600 border-b-2 border-blue-600': sidebarTab === 'cards', 'bg-gray-50 text-gray-500 hover:bg-gray-100': sidebarTab !== 'cards'}"
                        class="flex-1 py-3 font-bold transition text-center"
                    >
                        ğŸ—‚ï¸ å¡ç‰‡
                    </button>
                    <button 
                        @click="sidebarTab = 'templates'" 
                        :class="{'bg-white text-blue-600 border-b-2 border-blue-600': sidebarTab === 'templates', 'bg-gray-50 text-gray-500 hover:bg-gray-100': sidebarTab !== 'templates'}"
                        class="flex-1 py-3 font-bold transition text-center"
                    >
                        ğŸ“ ç‰ˆå‹
                    </button>
                    <!-- Mobile Layer List Tab (Only visible in mobile, or always if moving completely?) User said "put into hamburger", implies it joins the sidebar tabs -->
                    <button 
                        @click="sidebarTab = 'layers'" 
                        :class="{'bg-white text-blue-600 border-b-2 border-blue-600': sidebarTab === 'layers', 'bg-gray-50 text-gray-500 hover:bg-gray-100': sidebarTab !== 'layers'}"
                        class="flex-1 py-3 font-bold transition text-center md:hidden"
                    >
                        ğŸ“‘ åœ–å±¤
                    </button>
                </div>

                <!-- 1. å¡ç‰‡æ¸…å–®è¦–åœ– -->
                <template v-if="sidebarTab === 'cards'">
                    <div class="flex-1 overflow-y-auto">
                        <div 
                            v-for="(card, idx) in currentProject.cards" 
                            :key="card.id"
                            @click="selectCard(card.id)"
                            @dblclick="startCardRenaming(card)"
                            class="p-3 border-b cursor-pointer hover:bg-blue-50 flex justify-between items-center group"
                            :class="{'bg-blue-100 border-l-4 border-l-blue-500': currentCard && currentCard.id === card.id}"
                        >
                            <span v-if="renamingCardId !== card.id" class="truncate text-sm font-medium select-none">{{ idx + 1 }}. {{ card.name || 'æœªå‘½åå¡ç‰‡' }}</span>
                            <input 
                                v-else 
                                v-model="card.name" 
                                @blur="finishCardRenaming" 
                                @keydown.enter="finishCardRenaming"
                                @click.stop
                                ref="cardNameInput"
                                class="flex-1 min-w-0 border rounded px-1 py-0.5 text-sm mr-2"
                            >
                            
                            <div v-if="renamingCardId !== card.id" class="hidden group-hover:flex gap-1">
                                <button @click.stop="cloneCard(card)" title="è¤‡è£½" class="text-xs text-gray-500 hover:text-blue-600">ğŸ“„</button>
                                <button @click.stop="deleteCard(idx)" title="åˆªé™¤" class="text-xs text-gray-500 hover:text-red-600">ğŸ—‘ï¸</button>
                            </div>
                        </div>
                    </div>
                    <div class="p-3 border-t relative" @mouseleave="showNewCardMenu = false">
                        <div v-if="showNewCardMenu" class="absolute bottom-full left-3 right-3 bg-white border border-gray-200 shadow-xl rounded-t-lg mb-0 pb-1 overflow-hidden z-20">
                            <div class="bg-gray-50 px-3 py-1 text-xs text-gray-500 font-bold border-b">é¸æ“‡å°ºå¯¸</div>
                            <button 
                                v-for="(size, idx) in cardSizes" 
                                :key="idx"
                                @click="addNewCard(size)"
                                class="w-full text-left px-4 py-3 hover:bg-blue-50 text-sm flex justify-between items-center border-b last:border-0"
                            >
                                <span class="font-bold text-gray-700">{{ size.name }}</span>
                                <span class="text-xs text-gray-400 bg-gray-100 px-1 rounded">{{ size.w }}x{{ size.h }}mm</span>
                            </button>
                        </div>
                        <button @click="showNewCardMenu = !showNewCardMenu" class="w-full bg-blue-500 text-white py-2 rounded text-sm hover:bg-blue-600 font-bold flex justify-center items-center gap-1">
                            <span>â• æ–°å¢å¡ç‰‡</span>
                            <span class="text-xs transition-transform duration-200" :class="{'rotate-180': showNewCardMenu}">â–²</span>
                        </button>
                    </div>
                </template>

                <!-- 2. ç‰ˆå‹åˆ—è¡¨è¦–åœ– -->
                <template v-if="sidebarTab === 'templates'">
                     <div class="flex-1 overflow-y-auto p-2 space-y-2 bg-gray-50">
                        <div v-if="currentProject.localTypes.length === 0" class="text-center text-gray-400 mt-10 text-sm">
                            å°šç„¡å°ˆæ¡ˆç‰ˆå‹<br>
                            <span class="text-xs">è«‹å¾å³å´å±¬æ€§æ¬„å„²å­˜ç‰ˆå‹</span>
                        </div>
                        <div 
                            v-for="(type, idx) in currentProject.localTypes" 
                            :key="type.id"
                            @dblclick="startTypeRenaming(type)"
                            class="bg-white border rounded p-3 shadow-sm hover:shadow transition group relative"
                        >
                            <div class="flex justify-between items-start mb-2">
                                <span v-if="renamingTypeId !== type.id" class="font-bold text-sm text-gray-700 truncate mr-2 select-none">{{ type.name }}</span>
                                <input 
                                    v-else 
                                    v-model="type.name" 
                                    @blur="finishTypeRenaming" 
                                    @keydown.enter="finishTypeRenaming"
                                    @click.stop
                                    ref="typeNameInput"
                                    class="flex-1 min-w-0 border rounded px-1 py-0.5 text-sm font-bold text-gray-700 mr-2"
                                >
                                <button @click="deleteLocalType(idx)" class="text-gray-400 hover:text-red-500 flex-shrink-0" title="åˆªé™¤ç‰ˆå‹">ğŸ—‘ï¸</button>
                            </div>
                            <div class="text-xs text-gray-500 mb-2 flex gap-2">
                                <span>{{ type.width || 63 }}x{{ type.height || 88 }}mm</span>
                                <span>â€¢ {{ type.elements.length }} å…ƒç´ </span>
                                <div class="w-3 h-3 border" :style="{backgroundColor: type.bgColor}"></div>
                            </div>
                            <button @click="applyCardType(type)" class="w-full bg-blue-50 text-blue-600 border border-blue-200 text-xs py-1 rounded hover:bg-blue-100 font-bold">
                                å¥—ç”¨æ­¤ç‰ˆå‹
                            </button>
                        </div>
                     </div>
                </template>
                <!-- 3. åœ–å±¤æ¸…å–®è¦–åœ– (Mobile Only in Sidebar) -->
                <template v-if="sidebarTab === 'layers'">
                    <div class="flex-1 overflow-y-auto p-2 space-y-1">
                        <div v-if="!currentCard" class="text-center text-gray-400 mt-10 text-sm">è«‹é¸æ“‡ä¸€å¼µå¡ç‰‡</div>
                        <template v-else>
                            <div 
                                v-for="el in elementList" 
                                :key="el.id"
                                class="flex items-center gap-2 p-2 rounded border hover:border-blue-300 transition text-sm group bg-white"
                                :class="{'bg-blue-50 border-blue-500': selectedElementId === el.id}"
                                @click="selectCard(currentCard.id); selectedElementId = el.id; showLeftSidebar = false"
                            >
                                <!-- Icon -->
                                <div class="text-xs w-5 text-center flex-shrink-0">
                                    <span v-if="el.type === 'text'">ğŸ“</span>
                                    <span v-else>
                                        <div class="w-3 h-3 mx-auto border border-gray-300" :style="{backgroundColor: el.color, borderRadius: el.shapeType === 'circle' ? '50%' : '0'}"></div>
                                    </span>
                                </div>
                                
                                <!-- Content Preview -->
                                <div class="flex-1 truncate select-none">
                                    <span v-if="el.type === 'text'" class="font-medium text-gray-700">{{ el.content || '(ç©ºç™½æ–‡å­—)' }}</span>
                                    <span v-else class="text-gray-500 capitalize">{{ el.shapeType }}</span>
                                </div>

                                <!-- Z-Index Badge -->
                                <div class="text-[10px] text-gray-400 font-mono bg-gray-100 px-1 rounded">
                                    z:{{ el.z }}
                                </div>

                                <!-- Actions -->
                                <div class="flex gap-1 ml-1">
                                    <button @click.stop="cloneElement(el)" title="è¤‡è£½" class="p-1 hover:bg-blue-100 rounded text-gray-500 hover:text-blue-600">ğŸ“„</button>
                                    <button @click.stop="removeElement(el.id)" title="åˆªé™¤" class="p-1 hover:bg-red-100 rounded text-gray-500 hover:text-red-600">ğŸ—‘ï¸</button>
                                </div>
                            </div>
                            <div v-if="currentCard.elements.length === 0" class="text-center text-gray-400 text-xs mt-4">
                                å°šç„¡å…ƒç´ 
                            </div>
                        </template>
                    </div>
                </template>
            </div>

            <!-- ä¸­é–“ï¼šç•«å¸ƒ (Workspace) -->
            <div class="flex-1 bg-gray-200 relative flex flex-col overflow-hidden mb-[40vh] md:mb-0" @click="deselectElement">
                
                <!-- å·¥å…·åˆ— (Toolbar) -->
                <div class="w-full p-2 z-20 flex justify-center md:justify-start shrink-0">
                    <div class="flex gap-2 bg-white p-2 rounded shadow-md">
                        <button @click.stop="addElement('text')" class="flex items-center gap-1 px-3 py-1 bg-gray-100 hover:bg-gray-200 rounded text-sm">ğŸ“ <span class="hidden sm:inline">æ–‡å­—</span></button>
                        <button @click.stop="addElement('shape')" class="flex items-center gap-1 px-3 py-1 bg-gray-100 hover:bg-gray-200 rounded text-sm">â¹ï¸ <span class="hidden sm:inline">å½¢ç‹€</span></button>
                        <div class="w-px h-6 bg-gray-300 mx-1"></div>
                        <div class="relative group">
                            <button class="flex items-center gap-1 px-3 py-1 bg-purple-100 hover:bg-purple-200 text-purple-800 rounded text-sm font-bold">
                                ğŸ§© <span class="hidden sm:inline">å¥—ç”¨ç‰ˆå‹</span>
                            </button>
                            <!-- Dropdown -->
                            <div class="absolute top-full left-0 w-64 bg-white rounded shadow-xl border hidden group-hover:block z-30">
                                <div class="p-2 text-xs font-bold text-gray-500 bg-gray-50">å…¨åŸŸåº«</div>
                                <div v-for="type in globalLibrary" :key="type.id" @click="applyCardType(type)" class="px-4 py-2 hover:bg-blue-50 cursor-pointer text-sm border-b last:border-0">
                                    <div class="flex justify-between font-bold">
                                        <span>{{ type.name }}</span>
                                        <span class="text-xs text-gray-400 font-normal">{{ type.width || 63 }}x{{ type.height || 88 }}mm</span>
                                    </div>
                                    <div class="text-xs text-gray-400 mt-1 flex justify-between">
                                        <span>å°ˆæ¡ˆ: {{ type.sourceProject || '-' }}</span>
                                        <span>{{ type.elements.length }} å…ƒç´ </span>
                                    </div>
                                </div>
                                <div v-if="globalLibrary.length === 0" class="px-4 py-2 text-gray-400 text-xs italic">ç„¡å…¨åŸŸç‰ˆå‹</div>
                                
                                <div class="p-2 text-xs font-bold text-gray-500 bg-gray-50 border-t">å°ˆæ¡ˆåº«</div>
                                <div v-for="type in currentProject.localTypes" :key="type.id" @click="applyCardType(type)" class="px-4 py-2 hover:bg-blue-50 cursor-pointer text-sm border-b last:border-0">
                                    <div class="flex justify-between font-bold">
                                        <span>{{ type.name }}</span>
                                        <span class="text-xs text-gray-400 font-normal">{{ type.width || 63 }}x{{ type.height || 88 }}mm</span>
                                    </div>
                                    <div class="text-xs text-gray-400 mt-1">{{ type.elements.length }} å…ƒç´ </div>
                                </div>
                                <div v-if="currentProject.localTypes.length === 0" class="px-4 py-2 text-gray-400 text-xs italic">ç„¡å°ˆæ¡ˆç‰ˆå‹</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ç•«å¸ƒå€åŸŸ -->
                <div class="flex-1 overflow-auto flex flex-col items-center justify-center p-4 md:p-8">
                    <div v-if="currentCard" class="relative">
                    <!-- æ¯”ä¾‹å°ºæ¨™ç¤º -->
                    <div class="absolute -top-6 left-0 text-xs text-gray-500">{{ currentCard.width || 63 }}mm</div>
                    <div class="absolute top-0 -left-8 text-xs text-gray-500 h-full flex items-center" style="writing-mode: vertical-rl;">{{ currentCard.height || 88 }}mm</div>
                    
                    <!-- å¡ç‰‡æœ¬é«” -->
                    <div 
                        class="card-canvas"
                        :style="{
                            width: (currentCard.width || 63) * screenScale + 'px',
                            height: (currentCard.height || 88) * screenScale + 'px',
                            backgroundColor: currentCard.bgColor || '#ffffff',
                            border: `${currentCard.borderWidth || 0}px solid ${currentCard.borderColor || '#000000'}`
                        }"
                        @mousemove="onMouseMove" 
                        @touchmove.prevent="onMouseMove"
                        @mouseup="onMouseUp"
                        @mouseleave="onMouseUp"
                        @touchend="onMouseUp"
                    >
                        <div 
                            v-for="element in currentCard.elements" 
                            :key="element.id"
                            :style="getElementStyle(element)"
                            class="absolute cursor-move hover:outline hover:outline-1 hover:outline-blue-300 no-select flex items-center justify-center overflow-hidden"
                            :class="{'element-selected': selectedElementId === element.id}"
                            @mousedown.stop="startDrag($event, element)"
                            @touchstart.stop="startDrag($event, element)"
                            @dblclick.stop="startTextEditing(element)"
                            @click.stop
                        >
                            <!-- Text Content Display -->
                            <span 
                                v-if="element.type === 'text' && editingElementId !== element.id" 
                                :style="{ fontSize: element.fontSize + 'px', color: element.color, textAlign: element.textAlign }" 
                                class="w-full pointer-events-none whitespace-pre-wrap"
                            >
                                {{ element.content || 'æ–‡å­—' }}
                            </span>

                            <!-- Text Content Editor (In-Place) -->
                            <div
                                v-if="element.type === 'text' && editingElementId === element.id"
                                contenteditable="true"
                                class="w-full h-full outline-none whitespace-pre-wrap cursor-text"
                                :style="{ fontSize: element.fontSize + 'px', color: element.color, textAlign: element.textAlign }"
                                @blur="finishTextEditing($event, element)"
                                @input="element.content = $event.target.innerText"
                                @mousedown.stop
                                @keydown="handleEditKeydown"
                                ref="editableDiv"
                            ></div>
                        </div>
                    </div>
                </div>
                <div v-else class="text-gray-400 text-lg">è«‹é¸æ“‡æˆ–å»ºç«‹ä¸€å¼µå¡ç‰‡</div>
                </div>

            </div>

            <!-- å³å´ï¼šå±¬æ€§æª¢æŸ¥å™¨ (Inspector) -->
            <!-- Desktop: Standard Sidebar / Mobile: Bottom Sheet Footer -->
            <div class="fixed inset-x-0 bottom-0 h-[40vh] bg-white border-t flex flex-col z-[45] transform transition-transform duration-300 md:static md:inset-auto md:h-auto md:w-72 md:border-t-0 md:border-l md:translate-y-0"
                 :class="{'translate-y-0 shadow-[0_-5px_20px_rgba(0,0,0,0.1)]': currentView === 'editor', 'translate-y-full md:translate-y-0': currentView !== 'editor'}"> <!-- Always visible in editor mode on mobile, but styled as footer -->
                
                <!-- Mobile Handle / Toggle (Optional if always visible, but maybe collapsible?) -->
                <!-- Let's make it collapsible on mobile? User said "æ”¹åœ¨ä¸‹æ–¹footerbarå‘ˆç¾". Usually implies always visible or tabbed.
                     But if it takes 40vh, it might block view. Let's assume it replaces the previous toolbar.
                     Wait, if it's properties, it should probably be visible when an element is selected?
                     Or just always there. Let's keep it simple: A scrollable footer area.
                -->
                
                <!-- Mobile Drag Handle / Header -->
                <div class="md:hidden flex justify-center items-center py-2 border-b bg-gray-50 cursor-pointer" @click="showMobileInspector = !showMobileInspector">
                    <div class="w-10 h-1 bg-gray-300 rounded-full"></div>
                </div>

                <!-- ä¸ŠåŠéƒ¨ï¼šå±¬æ€§ç·¨è¼¯å€ (å¯æ»¾å‹•) -->
                <div class="flex-1 overflow-y-auto min-h-0 relative" :class="{'hidden md:block': !showMobileInspector}">
                    <div class="p-4 border-b bg-gray-50 sticky top-0 z-10">
                        <h3 class="font-bold text-gray-700">ğŸ¨ å±¬æ€§æª¢æŸ¥å™¨</h3>
                    </div>

                    <div v-if="selectedElement" class="p-4 space-y-4">
                    <!-- é€šç”¨å±¬æ€§ -->
                    <div>
                        <label class="text-xs font-bold text-gray-500 block mb-1">ä½ç½®èˆ‡å°ºå¯¸ (px)</label>
                        
                        <!-- X & Y Inputs and Sliders -->
                        <div class="mb-4 space-y-2">
                             <div class="flex items-center gap-2">
                                <span class="text-xs text-gray-400 w-3 font-bold">X</span>
                                <input type="number" v-model.number="selectedElement.x" class="w-16 border rounded px-2 py-1 text-sm">
                                <input type="range" v-model.number="selectedElement.x" min="-100" :max="(currentCard.width || 63) * screenScale + 50" class="flex-1 h-1 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                             </div>
                             <div class="flex items-center gap-2">
                                <span class="text-xs text-gray-400 w-3 font-bold">Y</span>
                                <input type="number" v-model.number="selectedElement.y" class="w-16 border rounded px-2 py-1 text-sm">
                                <input type="range" v-model.number="selectedElement.y" min="-100" :max="(currentCard.height || 88) * screenScale + 50" class="flex-1 h-1 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                             </div>
                        </div>

                        <!-- W & H Inputs and Sliders -->
                        <div class="mb-2 space-y-2 border-t pt-2">
                             <div class="flex items-center gap-2">
                                <span class="text-xs text-gray-400 w-3 font-bold">W</span>
                                <input type="number" v-model.number="selectedElement.w" class="w-16 border rounded px-2 py-1 text-sm">
                                <input type="range" v-model.number="selectedElement.w" min="10" :max="(currentCard.width || 63) * screenScale" class="flex-1 h-1 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                             </div>
                             <div class="flex items-center gap-2">
                                <span class="text-xs text-gray-400 w-3 font-bold">H</span>
                                <input type="number" v-model.number="selectedElement.h" class="w-16 border rounded px-2 py-1 text-sm">
                                <input type="range" v-model.number="selectedElement.h" min="10" :max="(currentCard.height || 88) * screenScale" class="flex-1 h-1 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                             </div>
                        </div>
                        <div class="grid grid-cols-6 gap-1 mt-2">
                             <button @click="alignElement('left')" title="ç½®å·¦" class="bg-gray-100 hover:bg-gray-200 border rounded p-1 text-xs font-mono">|&lt;</button>
                             <button @click="alignElement('center-h')" title="æ°´å¹³ç½®ä¸­" class="bg-gray-100 hover:bg-gray-200 border rounded p-1 text-xs font-mono">&gt;|&lt;</button>
                             <button @click="alignElement('right')" title="ç½®å³" class="bg-gray-100 hover:bg-gray-200 border rounded p-1 text-xs font-mono">&gt;|</button>
                             <button @click="alignElement('top')" title="ç½®é ‚" class="bg-gray-100 hover:bg-gray-200 border rounded p-1 text-xs font-mono">T</button>
                             <button @click="alignElement('center-v')" title="å‚ç›´ç½®ä¸­" class="bg-gray-100 hover:bg-gray-200 border rounded p-1 text-xs font-mono">M</button>
                             <button @click="alignElement('bottom')" title="ç½®åº•" class="bg-gray-100 hover:bg-gray-200 border rounded p-1 text-xs font-mono">B</button>
                        </div>
                    </div>

                    <div>
                        <label class="text-xs font-bold text-gray-500 block mb-1">å±¤ç´š (Z-Index)</label>
                        <div class="flex gap-2 items-center">
                            <div class="flex border rounded overflow-hidden flex-1 h-9">
                                <button @click="bringToFront" class="flex-1 bg-gray-50 hover:bg-gray-100 border-r text-xs font-bold flex items-center justify-center gap-1" title="ç§»è‡³æœ€ä¸Šå±¤">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="18 15 12 9 6 15"></polyline></svg>
                                    ç½®é ‚
                                </button>
                                <button @click="sendToBack" class="flex-1 bg-gray-50 hover:bg-gray-100 text-xs font-bold flex items-center justify-center gap-1" title="ç§»è‡³æœ€ä¸‹å±¤">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
                                    ç½®åº•
                                </button>
                            </div>
                            <input type="number" v-model.number="selectedElement.z" min="0" max="100" class="w-20 border rounded px-2 py-2 text-sm text-center h-9" title="æ‰‹å‹•è¼¸å…¥å±¤ç´š">
                        </div>
                    </div>

                    <!-- å½¢ç‹€å°ˆå±¬ -->
                    <div v-if="selectedElement.type === 'shape'">
                        <label class="text-xs font-bold text-gray-500 block mb-1">æ¨£å¼</label>
                        <div class="space-y-4">
                            <color-picker v-model="selectedElement.color" label="é¡è‰²"></color-picker>
                            
                            <div>
                                <span class="text-xs text-gray-400 block mb-1">å½¢ç‹€é¸æ“‡</span>
                                <div class="grid grid-cols-4 gap-2">
                                    <button @click="selectedElement.shapeType = 'rectangle'" :class="{'bg-blue-100 border-blue-500': !selectedElement.shapeType || selectedElement.shapeType === 'rectangle'}" class="border rounded p-1 hover:bg-gray-100 flex items-center justify-center h-8" title="çŸ©å½¢">
                                        <div class="w-4 h-4 bg-gray-600"></div>
                                    </button>
                                    <button @click="selectedElement.shapeType = 'circle'" :class="{'bg-blue-100 border-blue-500': selectedElement.shapeType === 'circle'}" class="border rounded p-1 hover:bg-gray-100 flex items-center justify-center h-8" title="åœ“å½¢">
                                        <div class="w-4 h-4 bg-gray-600 rounded-full"></div>
                                    </button>
                                    <button @click="selectedElement.shapeType = 'triangle'" :class="{'bg-blue-100 border-blue-500': selectedElement.shapeType === 'triangle'}" class="border rounded p-1 hover:bg-gray-100 flex items-center justify-center h-8" title="ä¸‰è§’å½¢">
                                        <div class="w-0 h-0 border-l-[8px] border-l-transparent border-r-[8px] border-r-transparent border-b-[14px] border-b-gray-600"></div>
                                    </button>
                                    <button @click="selectedElement.shapeType = 'triangle-inverted'" :class="{'bg-blue-100 border-blue-500': selectedElement.shapeType === 'triangle-inverted'}" class="border rounded p-1 hover:bg-gray-100 flex items-center justify-center h-8" title="å€’ä¸‰è§’å½¢">
                                        <div class="w-0 h-0 border-l-[8px] border-l-transparent border-r-[8px] border-r-transparent border-t-[14px] border-t-gray-600"></div>
                                    </button>
                                    <button @click="selectedElement.shapeType = 'star'" :class="{'bg-blue-100 border-blue-500': selectedElement.shapeType === 'star'}" class="border rounded p-1 hover:bg-gray-100 flex items-center justify-center h-8" title="æ˜Ÿå½¢">
                                        <div class="w-4 h-4 bg-gray-600" style="clip-path: polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%);"></div>
                                    </button>
                                    <button @click="selectedElement.shapeType = 'hexagon'" :class="{'bg-blue-100 border-blue-500': selectedElement.shapeType === 'hexagon'}" class="border rounded p-1 hover:bg-gray-100 flex items-center justify-center h-8" title="å…­é‚Šå½¢">
                                        <div class="w-4 h-4 bg-gray-600" style="clip-path: polygon(25% 0%, 75% 0%, 100% 50%, 75% 100%, 25% 100%, 0% 50%);"></div>
                                    </button>
                                    <button @click="selectedElement.shapeType = 'heart'" :class="{'bg-blue-100 border-blue-500': selectedElement.shapeType === 'heart'}" class="border rounded p-1 hover:bg-gray-100 flex items-center justify-center h-8" title="æ„›å¿ƒ">
                                        <div class="w-4 h-4 bg-gray-600" style="clip-path: polygon(50% 85%, 100% 38%, 82% 0%, 50% 25%, 18% 0%, 0% 38%);"></div>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- æ–‡å­—å°ˆå±¬ -->
                    <div v-if="selectedElement.type === 'text'">
                        <label class="text-xs font-bold text-gray-500 block mb-1">å…§å®¹èˆ‡æ–‡å­—</label>
                        <textarea v-model="selectedElement.content" rows="3" class="w-full border rounded p-2 text-sm mb-2" placeholder="è¼¸å…¥æ–‡å­—..."></textarea>
                        
                        <div class="mb-4">
                            <span class="text-xs text-gray-400 block mb-1">å­—é«”å¤§å° & å°é½Š</span>
                            <div class="flex gap-2 items-center">
                                <input type="number" v-model.number="selectedElement.fontSize" class="w-20 border rounded px-2 py-2 text-sm text-center" title="å­—é«”å¤§å°">
                                
                                <div class="flex border rounded overflow-hidden flex-1 h-9">
                                    <button @click="selectedElement.textAlign = 'left'" :class="{'bg-gray-200': selectedElement.textAlign === 'left'}" class="flex-1 hover:bg-gray-100 border-r flex justify-center items-center" title="é å·¦å°é½Š">
                                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <line x1="17" y1="10" x2="3" y2="10"></line>
                                            <line x1="21" y1="6" x2="3" y2="6"></line>
                                            <line x1="21" y1="14" x2="3" y2="14"></line>
                                            <line x1="17" y1="18" x2="3" y2="18"></line>
                                        </svg>
                                    </button>
                                    <button @click="selectedElement.textAlign = 'center'" :class="{'bg-gray-200': selectedElement.textAlign === 'center'}" class="flex-1 hover:bg-gray-100 border-r flex justify-center items-center" title="ç½®ä¸­å°é½Š">
                                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <line x1="21" y1="6" x2="3" y2="6"></line>
                                            <line x1="17" y1="10" x2="7" y2="10"></line>
                                            <line x1="19" y1="14" x2="5" y2="14"></line>
                                            <line x1="21" y1="18" x2="3" y2="18"></line>
                                        </svg>
                                    </button>
                                    <button @click="selectedElement.textAlign = 'right'" :class="{'bg-gray-200': selectedElement.textAlign === 'right'}" class="flex-1 hover:bg-gray-100 flex justify-center items-center" title="é å³å°é½Š">
                                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                            <line x1="21" y1="10" x2="7" y2="10"></line>
                                            <line x1="21" y1="6" x2="3" y2="6"></line>
                                            <line x1="21" y1="14" x2="3" y2="14"></line>
                                            <line x1="21" y1="18" x2="7" y2="18"></line>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        </div>
                        <color-picker v-model="selectedElement.color" label="æ–‡å­—é¡è‰²" class="mb-4"></color-picker>
                    </div>

                    <div class="pt-4 border-t mt-4" v-if="false"> <!-- Removed Delete Button from here -->
                    </div>
                </div>
                
                <div v-else-if="currentCard" class="p-4 space-y-4">
                    <!-- å¡ç‰‡æœ¬èº«å±¬æ€§ -->
                    <div>
                        <label class="text-xs font-bold text-gray-500 block mb-1">å¡ç‰‡å°ºå¯¸èˆ‡æ–¹å‘</label>
                        <div class="flex gap-2 mb-2">
                             <button @click="setCardOrientation('portrait')" :class="{'bg-blue-100 border-blue-500 text-blue-700': isPortrait, 'bg-gray-50 hover:bg-gray-100': !isPortrait}" class="flex-1 border rounded py-2 text-xs font-bold flex flex-col items-center gap-1 transition">
                                <div class="w-3 h-4 border-2 border-current rounded-sm"></div>
                                ç›´å¼
                             </button>
                             <button @click="setCardOrientation('landscape')" :class="{'bg-blue-100 border-blue-500 text-blue-700': !isPortrait, 'bg-gray-50 hover:bg-gray-100': isPortrait}" class="flex-1 border rounded py-2 text-xs font-bold flex flex-col items-center gap-1 transition">
                                <div class="w-4 h-3 border-2 border-current rounded-sm"></div>
                                æ©«å¼
                             </button>
                        </div>
                        <div class="flex items-center gap-2 text-xs text-gray-500 justify-center">
                            {{ currentCard.width || 63 }} x {{ currentCard.height || 88 }} mm
                        </div>
                    </div>

                    <!-- å¡ç‰‡å¤–è§€ -->
                    <div class="pt-4 border-t space-y-4">
                        <label class="text-xs font-bold text-gray-500 block">å¡ç‰‡å¤–è§€</label>
                        
                        <color-picker v-model="currentCard.bgColor" label="èƒŒæ™¯é¡è‰²"></color-picker>
                        <color-picker v-model="currentCard.borderColor" label="å¤–æ¡†é¡è‰²"></color-picker>

                        <div>
                            <span class="text-xs font-bold text-gray-500 block mb-1">å¤–æ¡†å¯¬åº¦</span>
                            <div class="flex items-center gap-2">
                                <input type="number" v-model.number="currentCard.borderWidth" min="0" max="20" class="w-16 border rounded px-2 py-1 text-sm text-center" placeholder="0">
                                <div class="flex border rounded overflow-hidden">
                                    <button @click="currentCard.borderWidth = 1" class="px-3 py-1 bg-white hover:bg-gray-100 border-r text-xs font-medium text-gray-600 transition">1</button>
                                    <button @click="currentCard.borderWidth = 2" class="px-3 py-1 bg-white hover:bg-gray-100 border-r text-xs font-medium text-gray-600 transition">2</button>
                                    <button @click="currentCard.borderWidth = 5" class="px-3 py-1 bg-white hover:bg-gray-100 text-xs font-medium text-gray-600 transition">5</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- å¦å­˜ç‚ºç‰ˆå‹ -->
                    <div class="pt-4 border-t">
                        <h4 class="font-bold text-sm mb-2">ğŸ“¥ å¦å­˜ç‚ºç‰ˆå‹</h4>
                        <p class="text-xs text-gray-500 mb-2">å°‡ç›®å‰çš„ä½ˆå±€å„²å­˜ç‚ºç¯„æœ¬ã€‚</p>
                        <div class="flex flex-col gap-2">
                            <input type="text" v-model="newTypeName" placeholder="ç‰ˆå‹åç¨±..." class="border rounded px-2 py-1 text-sm">
                            <div class="flex gap-2">
                                <button @click="saveAsType('global')" class="flex-1 bg-purple-500 text-white py-1 rounded text-xs hover:bg-purple-600">å­˜å…¥å…¨åŸŸåº«</button>
                                <button @click="saveAsType('local')" class="flex-1 bg-indigo-500 text-white py-1 rounded text-xs hover:bg-indigo-600">å­˜å…¥å°ˆæ¡ˆåº«</button>
                            </div>
                            <div v-if="saveMessage" :class="saveMessageType === 'error' ? 'text-red-500' : 'text-green-600'" class="text-xs text-center font-bold transition-opacity">
                                {{ saveMessage }}
                            </div>
                        </div>
                    </div>
                </div>

                <div v-else class="p-10 text-center text-gray-400 text-sm">
                    è«‹é¸æ“‡ä¸€å€‹å…ƒç´ æˆ–å¡ç‰‡ä»¥ç·¨è¼¯å±¬æ€§
                </div>
            </div>

            <!-- ä¸‹åŠéƒ¨ï¼šåœ–å±¤æ¸…å–® (Desktop Only) -->
            <div class="h-1/3 border-t flex flex-col bg-white hidden md:flex" v-if="currentCard">
                <div class="p-2 border-b bg-gray-50 text-xs font-bold text-gray-500 flex justify-between items-center">
                    <span>åœ–å±¤æ¸…å–® ({{ currentCard.elements.length }})</span>
                </div>
                <div class="flex-1 overflow-y-auto p-2 space-y-1">
                    <div 
                        v-for="el in elementList" 
                        :key="el.id"
                        class="flex items-center gap-2 p-2 rounded border hover:border-blue-300 transition text-sm group"
                        :class="{'bg-blue-50 border-blue-500': selectedElementId === el.id, 'bg-white border-transparent hover:bg-gray-50': selectedElementId !== el.id}"
                        @click="selectCard(currentCard.id); selectedElementId = el.id"
                    >
                        <!-- Icon -->
                        <div class="text-xs w-5 text-center flex-shrink-0">
                            <span v-if="el.type === 'text'">ğŸ“</span>
                            <span v-else>
                                <div class="w-3 h-3 mx-auto border border-gray-300" :style="{backgroundColor: el.color, borderRadius: el.shapeType === 'circle' ? '50%' : '0'}"></div>
                            </span>
                        </div>
                        
                        <!-- Content Preview -->
                        <div class="flex-1 truncate select-none">
                            <span v-if="el.type === 'text'" class="font-medium text-gray-700">{{ el.content || '(ç©ºç™½æ–‡å­—)' }}</span>
                            <span v-else class="text-gray-500 capitalize">{{ el.shapeType }}</span>
                        </div>

                        <!-- Z-Index Badge -->
                        <div class="text-[10px] text-gray-400 font-mono bg-gray-100 px-1 rounded">
                            z:{{ el.z }}
                        </div>

                        <!-- Actions -->
                        <div class="flex gap-1 ml-1 opacity-0 group-hover:opacity-100 transition-opacity">
                            <button @click.stop="cloneElement(el)" title="è¤‡è£½" class="p-1 hover:bg-blue-100 rounded text-gray-500 hover:text-blue-600">ğŸ“„</button>
                            <button @click.stop="removeElement(el.id)" title="åˆªé™¤" class="p-1 hover:bg-red-100 rounded text-gray-500 hover:text-red-600">ğŸ—‘ï¸</button>
                        </div>
                    </div>
                    <div v-if="currentCard.elements.length === 0" class="text-center text-gray-400 text-xs mt-4">
                        å°šç„¡å…ƒç´ 
                    </div>
                </div>
            </div>

            <!-- Mobile Bottom Toolbar (Replaced by Inspector Footer, so removing old one) -->
        </div>
    </div>

        <!-- 3. è¼¸å‡ºåˆ—å°è¦–åœ– (Print Preview) -->
        <div v-if="currentView === 'print' && currentProject" class="flex flex-col md:flex-row flex-1 overflow-hidden relative">
            
            <!-- Mobile Backdrop -->
            <div v-if="showLeftSidebar" class="fixed inset-0 bg-black/50 z-[1990] md:hidden transition-opacity" @click="showLeftSidebar = false"></div>

            <!-- è¨­å®šå´æ¬„ (Desktop: Static Left / Mobile: Inside Drawer via Hamburger) -->
            <div class="fixed inset-y-0 left-0 w-80 max-w-full bg-white border-r flex flex-col p-4 overflow-y-auto z-[2000] transform transition-transform duration-300 md:relative md:w-72 md:translate-x-0 md:h-full md:z-auto md:shadow-none"
                 :class="showLeftSidebar ? 'translate-x-0 shadow-2xl' : '-translate-x-full'">
                
                <!-- Mobile Header -->
                <div class="flex items-center justify-between mb-4 pb-2 border-b md:hidden">
                    <h2 class="text-xl font-bold">ğŸ–¨ï¸ åŒ¯å‡ºè¨­å®š</h2>
                    <button class="p-2 text-gray-500 hover:text-gray-800 bg-white rounded-full shadow" @click="showLeftSidebar = false">âœ•</button>
                </div>

                <h2 class="text-xl font-bold mb-4 hidden md:block">ğŸ–¨ï¸ åŒ¯å‡ºè¨­å®š</h2>
                
                <div class="mb-6">
                    <button @click="exportToPng" :disabled="isExporting" class="w-full bg-blue-600 text-white py-3 rounded-lg font-bold hover:bg-blue-700 shadow-lg flex justify-center items-center gap-2 disabled:bg-gray-400">
                        <span v-if="!isExporting">ğŸ–¼ï¸ åŒ¯å‡ºåœ–ç‰‡ (PNG)</span>
                        <span v-else>è™•ç†ä¸­... ({{ exportProgress }})</span>
                    </button>
                    <div v-if="exportMessage" class="text-red-500 text-xs text-center font-bold mt-2 transition-opacity">
                        {{ exportMessage }}
                    </div>
                    <p class="text-xs text-gray-500 mt-2">æç¤ºï¼šå°‡ç›®å‰é è¦½çš„ A4 é é¢è½‰å­˜ç‚º PNG åœ–ç‰‡æª”æ¡ˆã€‚</p>
                </div>

                <div class="mb-6 border-b pb-4">
                    <h3 class="font-bold text-sm mb-2">æ’åˆ—æ¨¡å¼</h3>
                    <div class="flex bg-gray-100 rounded p-1">
                        <button 
                            @click="printLayoutMode = 'gap'" 
                            :class="{'bg-white shadow text-blue-600': printLayoutMode === 'gap', 'text-gray-500 hover:text-gray-700': printLayoutMode !== 'gap'}"
                            class="flex-1 py-1 text-sm rounded transition font-medium"
                        >
                            åˆ†é–‹ (2mm)
                        </button>
                        <button 
                            @click="printLayoutMode = 'snapped'" 
                            :class="{'bg-white shadow text-blue-600': printLayoutMode === 'snapped', 'text-gray-500 hover:text-gray-700': printLayoutMode !== 'snapped'}"
                            class="flex-1 py-1 text-sm rounded transition font-medium"
                        >
                            è²¼é½Š (0mm)
                        </button>
                    </div>
                </div>

                <div class="mb-4">
                    <label class="flex items-center justify-between mb-2">
                        <span class="font-bold text-sm">é¸æ“‡è¦åˆ—å°çš„å¡ç‰‡</span>
                        <button @click="toggleSelectAll" class="text-xs text-blue-500">å…¨é¸ / å–æ¶ˆ</button>
                    </label>
                    <div class="space-y-1 max-h-96 overflow-y-auto border rounded p-2 bg-gray-50">
                        <div v-for="card in currentProject.cards" :key="card.id" class="flex items-center gap-2 p-1 hover:bg-white border-b border-transparent hover:border-gray-200">
                            <label class="flex items-center gap-2 flex-1 cursor-pointer min-w-0">
                                <input type="checkbox" v-model="printSelection" :value="card.id" @change="ensureQuantity(card.id)">
                                <span class="text-sm truncate select-none">{{ card.name }}</span>
                            </label>
                            <input 
                                type="number" 
                                v-model.number="printQuantities[card.id]" 
                                min="0" 
                                class="w-12 border rounded px-1 text-right text-sm"
                                @input="onQuantityChange(card.id, $event.target.value)"
                                title="åˆ—å°å¼µæ•¸"
                                placeholder="0"
                            >
                        </div>
                    </div>
                </div>
                
                <div class="text-xs text-gray-400 mt-auto">
                    A4 å°ºå¯¸é è¦½ (3x3 Grid)
                </div>
            </div>

            <!-- é è¦½å€åŸŸ (Print Area) -->
            <div class="flex-1 bg-gray-500 overflow-x-hidden overflow-y-auto p-4 md:p-8 flex flex-col items-center gap-8 w-full">
                <!-- A4 Pages Loop -->
                <div 
                    v-for="(pageCards, pageIdx) in paginatedCards" 
                    :key="pageIdx"
                    class="bg-white shadow-2xl p-[5mm] min-h-[297mm] w-[210mm] print-page relative origin-top transform scale-[0.4] sm:scale-[0.6] md:scale-100 mb-[-160mm] sm:mb-[-100mm] md:mb-0"
                >
                    <!-- Page Number (Preview Only) -->
                    <div class="absolute -top-6 left-0 text-white text-xs no-print">Page {{ pageIdx + 1 }}</div>

                    <!-- Grid Container -->
                    <div class="print-grid" :style="{ gap: printLayoutMode === 'snapped' ? '0' : '2mm' }">
                        <div 
                            v-for="card in pageCards" 
                            :key="card._printId" 
                            class="print-card relative"
                            :style="{
                                width: card._printW + 'mm',
                                height: card._printH + 'mm',
                            }"
                        >
                            <!-- Card Content Wrapper (Handles rotation and actual card visuals) -->
                            <div 
                                class="absolute overflow-hidden"
                                :style="{
                                    width: (card.width || 63) + 'mm',
                                    height: (card.height || 88) + 'mm',
                                    top: card._rotate ? '50%' : '0',
                                    left: card._rotate ? '50%' : '0',
                                    transform: card._rotate ? 'translate(-50%, -50%) rotate(90deg)' : 'none',
                                    backgroundColor: card.bgColor || '#ffffff',
                                    border: `${(card.borderWidth || 0) * 0.2625}mm solid ${card.borderColor || '#000000'}`,
                                    // Add a light border for cutting line in preview/print if actual border is 0
                                    outline: (card.borderWidth || 0) === 0 ? '1px solid #ccc' : 'none'
                                }"
                            >
                                <!-- Print Card Elements -->
                                <div 
                                    v-for="el in card.elements" 
                                    :key="el.id"
                                    :style="getPrintElementStyle(el)"
                                    class="absolute flex items-center justify-center"
                                >
                                    <!-- Text Element -->
                                    <span v-if="el.type === 'text'" :style="{ fontSize: scaleVal(el.fontSize) + 'px', color: el.color, textAlign: el.textAlign, lineHeight: '1', fontFamily: 'sans-serif' }" class="w-full whitespace-pre-wrap block">
                                        {{ el.content }}
                                    </span>

                                    <!-- SVG Shape Element (For Print/Export Stability) -->
                                    <svg v-if="el.type === 'shape'" viewBox="0 0 100 100" preserveAspectRatio="none" class="w-full h-full block">
                                        <!-- Complex Shapes -->
                                        <polygon 
                                            v-if="el.shapeType !== 'circle' && el.shapeType !== 'rectangle'" 
                                            :points="getShapePoints(el.shapeType)" 
                                            :fill="el.color" 
                                        />
                                        <!-- Rectangle -->
                                        <rect 
                                            v-if="el.shapeType === 'rectangle'" 
                                            x="0" y="0" width="100" height="100" 
                                            :fill="el.color" 
                                        />
                                        <!-- Circle -->
                                        <circle 
                                            v-if="el.shapeType === 'circle'" 
                                            cx="50" cy="50" r="50" 
                                            :fill="el.color" 
                                        />
                                    </svg>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!-- Custom Color Picker Component Template -->
    <script type="text/x-template" id="color-picker-template">
        <div class="flex items-center justify-between">
            <span class="text-sm">{{ label }}</span>
            <div class="flex gap-1 items-center">
                <input type="color" :value="modelValue" @input="$emit('update:modelValue', $event.target.value)" list="preset-colors" class="h-6 w-8 border cursor-pointer p-0">
                <input type="text" :value="modelValue" @input="$emit('update:modelValue', $event.target.value)" class="w-20 text-xs border rounded px-1 h-6 font-mono">
            </div>
        </div>
    </script>

    <!-- Global Datalist for Native Picker -->
    <datalist id="preset-colors">
        <option>#ff0000</option>
        <option>#ffff00</option>
        <option>#00ff00</option>
        <option>#0000ff</option>
        <option>#8a2be2</option>
        <option>#ff8c00</option>
        <option>#000000</option>
        <option>#ffffff</option>
    </datalist>

    <!-- Vue App Script -->
    <script>
        const { createApp } = Vue;

        const ColorPicker = {
            template: '#color-picker-template',
            props: ['modelValue', 'label'],
            emits: ['update:modelValue'],
            data() {
                return {
                    swatches: [
                        '#ff0000', // Red
                        '#ffff00', // Yellow
                        '#00ff00', // Green
                        '#0000ff', // Blue
                        '#8a2be2', // Purple
                        '#ff8c00', // Orange
                        '#000000', // Black
                        '#ffffff'  // White
                    ]
                }
            }
        };

        createApp({
            components: {
                ColorPicker
            },
            data() {
                return {
                    currentView: 'projects', // 'projects', 'editor', 'print'
                    projects: [],
                    globalLibrary: [],
                    currentProjectId: null,
                    currentCardId: null,
                    
                    // Mobile State
                    showLeftSidebar: false,
                    showMobileInspector: true, // Default open on mobile footer
                    showMobileMenu: false, // New: Toggle for mobile top-right menu
                    
                    // Editor State
                    selectedElementId: null,
                    draggingElementId: null,
                    dragOffset: { x: 0, y: 0 },
                    newTypeName: '',
                    saveMessage: '',        // New: Temporary message for save feedback
                    saveMessageType: '',    // 'success' or 'error'
                    showNewCardMenu: false, // New: Toggle for new card dropdown
                    editingElementId: null, // New: Track which element is being edited
                    isEditingText: false,   // New: Flag to pause history during text edit
                    renamingCardId: null,   // New: Track which card is being renamed in sidebar
                    renamingTypeId: null,   // New: Track which template is being renamed
                    sidebarTab: 'cards',    // 'cards' or 'templates'
                    
                    // Print State
                    printSelection: [], // Array of card IDs
                    printQuantities: {}, // New: Map card ID to quantity
                    printLayoutMode: 'snapped', // New: 'gap' (2mm) or 'snapped' (0mm)
                    isExporting: false,
                    exportProgress: '',
                    exportMessage: '', // New: Temporary message for export feedback

                    // Undo/Redo State
                    history: [],
                    historyIndex: -1,
                    isUndoing: false,

                    // Consts
                    screenScale: 3.8, // 1mm approx 3.8px
                    cardSizes: [
                        { name: 'å¤§å¡', w: 63, h: 88 },
                        { name: 'æ’²å…‹', w: 55, h: 88 },
                        { name: 'å°å¡', w: 43, h: 68 }
                    ]
                }
            },
            computed: {
                currentProject() {
                    return this.projects.find(p => p.id === this.currentProjectId);
                },
                currentCard() {
                    if (!this.currentProject) return null;
                    return this.currentProject.cards.find(c => c.id === this.currentCardId);
                },
                selectedElement() {
                    if (!this.currentCard || !this.selectedElementId) return null;
                    return this.currentCard.elements.find(e => e.id === this.selectedElementId);
                },
                isPortrait() {
                    if (!this.currentCard) return true;
                    return (this.currentCard.height || 88) >= (this.currentCard.width || 63);
                },
                elementList() {
                    if (!this.currentCard) return [];
                    // Sort by z-index descending, then by array index descending (later in array = on top)
                    return this.currentCard.elements.map((el, index) => ({ el, index })).sort((a, b) => {
                        if (a.el.z !== b.el.z) return b.el.z - a.el.z;
                        return b.index - a.index;
                    }).map(item => item.el);
                },
                printableCards() {
                    if (!this.currentProject) return [];
                    const result = [];
                    
                    this.printSelection.forEach(id => {
                        const card = this.currentProject.cards.find(c => c.id === id);
                        if (card) {
                            const qty = this.printQuantities[id] || 1;
                            const w = card.width || 63;
                            const h = card.height || 88;
                            const isLandscape = w > h;

                            for (let i = 0; i < qty; i++) {
                                result.push({
                                    ...card,
                                    _printId: `${card.id}_${i}`,
                                    _rotate: isLandscape,
                                    // If rotating, use swapped dimensions for layout
                                    _printW: isLandscape ? h : w,
                                    _printH: isLandscape ? w : h
                                });
                            }
                        }
                    });
                    
                    return result;
                },
                paginatedCards() {
                    const cards = this.printableCards;
                    if (cards.length === 0) return [[]];

                    // Determine dimensions from the first card (assuming uniform size for batch print)
                    const firstCard = cards[0];
                    const w = firstCard._printW;
                    const h = firstCard._printH;
                    
                    if (!w || !h || w <= 0 || h <= 0) return [cards];

                    const gap = this.printLayoutMode === 'snapped' ? 0 : 2; // mm
                    
                    // A4 printable area (approx, with 5mm margin each side)
                    // A4: 210 x 297 mm
                    // Margin: 5mm * 2 = 10mm
                    const pageW = 210 - 10;
                    const pageH = 297 - 10;

                    // Calculate columns and rows
                    const cols = Math.floor((pageW + gap) / (w + gap));
                    const rows = Math.floor((pageH + gap) / (h + gap));
                    
                    // Safety check
                    const pageSize = Math.max(1, cols * rows);

                    const pages = [];
                    for (let i = 0; i < cards.length; i += pageSize) {
                        pages.push(cards.slice(i, i + pageSize));
                    }
                    return pages;
                }
            },
            watch: {
                currentView(newVal) {
                    // Reset mobile sidebar states on view change
                    this.showLeftSidebar = false;
                    this.showMobileInspector = true;
                    
                    // Specific logic per view
                    if (newVal === 'print') {
                        // "åŒ¯å‡ºæ¨¡å¼é è¨­å±•é–‹" -> Open Left Sidebar on Mobile
                        if (window.innerWidth < 768) {
                            this.showLeftSidebar = true;
                        }
                    }
                },
                // Auto-save on major changes (debounced in real app, simple here)
                projects: {
                    handler() { 
                        this.saveData(); 
                    },
                    deep: true
                },
                // Watch specifically for current card changes to push to history
                currentCard: {
                    handler(newVal) {
                        if (newVal && this.currentView === 'editor' && !this.isUndoing && !this.isEditingText) {
                            this.recordHistory();
                        }
                    },
                    deep: true
                },
                globalLibrary: {
                    handler() { this.saveData(); },
                    deep: true
                }
            },
            mounted() {
                this.loadData();
                window.addEventListener('keydown', this.handleKeydown);
                // Initial record after load if card exists
                if(this.currentCard) this.recordHistory();
            },
            beforeUnmount() {
                window.removeEventListener('keydown', this.handleKeydown);
            },
            methods: {
                // --- Helpers ---
                uuid() {
                    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                        var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                        return v.toString(16);
                    });
                },
                getCardById(id) {
                    return this.currentProject.cards.find(c => c.id === id);
                },

                // --- Project Management ---
                createProject() {
                    const name = prompt("è«‹è¼¸å…¥å°ˆæ¡ˆåç¨±:", "æ–°å°ˆæ¡ˆ");
                    if (!name) return;
                    const newProj = {
                        id: this.uuid(),
                        name: name,
                        cards: [],
                        localTypes: []
                    };
                    this.projects.push(newProj);
                },
                deleteProject(id) {
                    if(confirm('ç¢ºå®šè¦åˆªé™¤æ­¤å°ˆæ¡ˆå—ï¼Ÿ')) {
                        this.projects = this.projects.filter(p => p.id !== id);
                        if (this.currentProjectId === id) this.currentProjectId = null;
                    }
                },
                openProject(id) {
                    this.currentProjectId = id;
                    this.currentView = 'editor';
                    this.showLeftSidebar = false; // Reset sidebar
                    // Auto select first card or create one if empty
                    if (this.currentProject.cards.length === 0) {
                        this.addNewCard();
                    } else {
                        this.currentCardId = this.currentProject.cards[0].id;
                    }
                    // Reset print selection
                    this.printSelection = [];
                    // Reset History for new project/view
                    this.history = [];
                    this.historyIndex = -1;
                    this.$nextTick(() => {
                        this.recordHistory();
                    });
                },

                // --- History (Undo/Redo) ---
                recordHistory() {
                    if (!this.currentCard) return;
                    
                    // If we are not at the end of history, slice off the future
                    if (this.historyIndex < this.history.length - 1) {
                        this.history = this.history.slice(0, this.historyIndex + 1);
                    }

                    const snapshot = JSON.stringify(this.currentCard);
                    
                    // Avoid duplicate consecutive snapshots
                    if (this.history.length > 0 && this.history[this.history.length - 1] === snapshot) {
                        return;
                    }

                    this.history.push(snapshot);
                    this.historyIndex = this.history.length - 1;
                    
                    // Limit history size (optional, e.g. 50 steps)
                    if (this.history.length > 50) {
                        this.history.shift();
                        this.historyIndex--;
                    }
                },
                undo() {
                    if (this.historyIndex > 0) {
                        this.isUndoing = true;
                        this.historyIndex--;
                        const snapshot = JSON.parse(this.history[this.historyIndex]);
                        
                        // Restore state
                        // We need to find the card in the project array and update it
                        const cardIndex = this.currentProject.cards.findIndex(c => c.id === this.currentCardId);
                        if (cardIndex !== -1) {
                            this.currentProject.cards[cardIndex] = snapshot;
                            // Also update selection if selected element no longer exists or logic requires
                            this.selectedElementId = null; 
                        }
                        
                        this.$nextTick(() => {
                            this.isUndoing = false;
                        });
                    }
                },
                redo() {
                    if (this.historyIndex < this.history.length - 1) {
                        this.isUndoing = true;
                        this.historyIndex++;
                        const snapshot = JSON.parse(this.history[this.historyIndex]);
                        
                        const cardIndex = this.currentProject.cards.findIndex(c => c.id === this.currentCardId);
                        if (cardIndex !== -1) {
                            this.currentProject.cards[cardIndex] = snapshot;
                            this.selectedElementId = null;
                        }

                        this.$nextTick(() => {
                            this.isUndoing = false;
                        });
                    }
                },

                // --- Card Management ---
                addNewCard(sizeInput) {
                    let size = sizeInput;
                    
                    // Handle direct call without size (defaults to large card) or event object
                    if (!size || !size.w) {
                        // If it's an event or undefined, show menu logic is handled by UI toggle
                        // But if called programmatically:
                        size = this.cardSizes[0];
                    }

                    this.showNewCardMenu = false; // Close menu

                    const newCard = {
                        id: this.uuid(),
                        name: `${size.name} ${this.currentProject.cards.length + 1}`,
                        width: size.w,
                        height: size.h,
                        elements: [],
                        bgColor: '#ffffff',
                        borderColor: '#000000',
                        borderWidth: 0
                    };
                    this.currentProject.cards.push(newCard);
                    this.currentCardId = newCard.id;
                    this.selectedElementId = null;
                },
                selectCard(id) {
                    this.currentCardId = id;
                    this.selectedElementId = null;
                },
                deleteCard(idx) {
                    if(!confirm('ç¢ºå®šåˆªé™¤æ­¤å¡ç‰‡ï¼Ÿ')) return;
                    const cardId = this.currentProject.cards[idx].id;
                    this.currentProject.cards.splice(idx, 1);
                    
                    // Remove from print selection if present
                    this.printSelection = this.printSelection.filter(id => id !== cardId);

                    if (this.currentProject.cards.length > 0) {
                        this.currentCardId = this.currentProject.cards[0].id;
                    } else {
                        this.currentCardId = null;
                    }
                },
                cloneCard(card) {
                    const clone = JSON.parse(JSON.stringify(card));
                    clone.id = this.uuid();
                    clone.name += " (å‰¯æœ¬)";
                    // Assign new IDs to elements to avoid ref issues
                    clone.elements.forEach(el => el.id = this.uuid());
                    this.currentProject.cards.push(clone);
                },
                cloneElement(element) {
                    if (!this.currentCard) return;
                    const clone = JSON.parse(JSON.stringify(element));
                    clone.id = this.uuid();
                    // clone.x += 10; // Removed offset
                    // clone.y += 10; // Removed offset
                    // Put on top by default or keep same z? Let's put on top to see it.
                    // Or keep same z? Usually clone goes to top.
                    // Find max z in current elements
                    const maxZ = this.currentCard.elements.reduce((max, el) => Math.max(max, el.z), 0);
                    clone.z = maxZ + 1; 
                    
                    this.currentCard.elements.push(clone);
                    this.selectedElementId = clone.id;
                },

                // --- Editor / Elements ---
                addElement(type) {
                    if (!this.currentCard) return;
                    
                    const base = {
                        id: this.uuid(),
                        type: type,
                        x: 20,
                        y: 20,
                        z: this.currentCard.elements.length + 1,
                    };

                    if (type === 'text') {
                        Object.assign(base, {
                            w: 200, h: 40,
                            content: 'æ–°æ–‡å­—',
                            fontSize: 16,
                            color: '#000000',
                            textAlign: 'left'
                        });
                    } else if (type === 'shape') {
                        Object.assign(base, {
                            w: 30, h: 30,
                            color: '#e2e8f0',
                            shapeType: 'rectangle' // rectangle, circle, triangle, triangle-inverted, star, hexagon, heart
                        });
                    }
                    
                    this.currentCard.elements.push(base);
                    this.selectedElementId = base.id;
                },
                removeElement(id) {
                    this.currentCard.elements = this.currentCard.elements.filter(e => e.id !== id);
                    this.selectedElementId = null;
                },
                deselectElement() {
                    this.selectedElementId = null;
                },
                
                startCardRenaming(card) {
                    this.renamingCardId = card.id;
                    this.$nextTick(() => {
                        const inputs = this.$refs.cardNameInput;
                        if (Array.isArray(inputs)) {
                             const input = inputs.find(el => el);
                             if (input) {
                                 input.focus();
                                 input.select();
                             }
                        } else if (inputs) {
                             inputs.focus();
                             inputs.select();
                        }
                    });
                },
                finishCardRenaming() {
                    this.renamingCardId = null;
                },

                startTypeRenaming(type) {
                    this.renamingTypeId = type.id;
                    this.$nextTick(() => {
                        const inputs = this.$refs.typeNameInput;
                        if (Array.isArray(inputs)) {
                             const input = inputs.find(el => el);
                             if (input) {
                                 input.focus();
                                 input.select();
                             }
                        } else if (inputs) {
                             inputs.focus();
                             inputs.select();
                        }
                    });
                },
                finishTypeRenaming() {
                    this.renamingTypeId = null;
                    this.saveData();
                },

                setCardOrientation(dir) {
                    if (!this.currentCard) return;
                    const w = this.currentCard.width || 63;
                    const h = this.currentCard.height || 88;
                    
                    if (dir === 'portrait' && w > h) {
                        this.currentCard.width = h;
                        this.currentCard.height = w;
                    } else if (dir === 'landscape' && h > w) {
                        this.currentCard.width = h;
                        this.currentCard.height = w;
                    }
                },

                // --- Text Editing ---
                startTextEditing(element) {
                    if (element.type !== 'text') return;
                    this.editingElementId = element.id;
                    this.isEditingText = true;
                    this.selectedElementId = element.id; // Ensure it's selected
                    
                    this.$nextTick(() => {
                        // Find the ref for the current element
                        // refs in v-for are arrays, but since we toggle v-if, only one might be in DOM or we search for it
                        const el = Array.isArray(this.$refs.editableDiv) ? this.$refs.editableDiv.find(r => r) : this.$refs.editableDiv;
                        if (el) {
                            el.innerText = element.content; // Initialize content
                            el.focus();
                            // Optional: Select all text
                            // const range = document.createRange();
                            // range.selectNodeContents(el);
                            // const sel = window.getSelection();
                            // sel.removeAllRanges();
                            // sel.addRange(range);
                        }
                    });
                },
                finishTextEditing(event, element) {
                    if (!this.isEditingText) return;
                    
                    // Sync final content
                    if (event && event.target) {
                        element.content = event.target.innerText;
                    }
                    
                    this.isEditingText = false;
                    this.editingElementId = null;
                    
                    // Manually record history after edit is done
                    this.recordHistory();
                },
                handleEditKeydown(e) {
                    // Prevent deleting the element when pressing Delete/Backspace during editing
                    e.stopPropagation(); 
                },

                handleKeydown(e) {
                    // Undo / Redo
                    if (this.currentView === 'editor' && (e.ctrlKey || e.metaKey)) {
                        if (e.key === 'z' || e.key === 'Z') {
                            e.preventDefault();
                            if (e.shiftKey) {
                                this.redo();
                            } else {
                                this.undo();
                            }
                            return;
                        }
                        if (e.key === 'y' || e.key === 'Y') {
                            e.preventDefault();
                            this.redo();
                            return;
                        }
                    }

                    if (this.currentView === 'editor' && this.selectedElementId && (e.key === 'Delete' || e.key === 'Backspace')) {
                        // Avoid deleting if typing in an input
                        if (e.target.tagName !== 'INPUT' && e.target.tagName !== 'TEXTAREA') {
                            this.removeElement(this.selectedElementId);
                        }
                    }
                },

                alignElement(align) {
                    if (!this.selectedElement) return;
                    // Dynamic Card Size
                    const cardW = (this.currentCard.width || 63) * this.screenScale;
                    const cardH = (this.currentCard.height || 88) * this.screenScale;
                    const el = this.selectedElement;

                    switch(align) {
                        case 'left': el.x = 0; break;
                        case 'center-h': el.x = (cardW - el.w) / 2; break;
                        case 'right': el.x = cardW - el.w; break;
                        case 'top': el.y = 0; break;
                        case 'center-v': el.y = (cardH - el.h) / 2; break;
                        case 'bottom': el.y = cardH - el.h; break;
                    }
                },

                bringToFront() {
                    if (!this.selectedElement) return;
                    this.selectedElement.z = 100;
                    
                    // Move to end of array to ensure visual top among same z-index
                    const idx = this.currentCard.elements.indexOf(this.selectedElement);
                    if (idx !== -1 && idx < this.currentCard.elements.length - 1) {
                        // Remove and push to end
                        const el = this.currentCard.elements.splice(idx, 1)[0];
                        this.currentCard.elements.push(el);
                    }
                },

                sendToBack() {
                    if (!this.selectedElement) return;
                    this.selectedElement.z = 0;
                    
                    // Move to start of array to ensure visual bottom among same z-index
                    const idx = this.currentCard.elements.indexOf(this.selectedElement);
                    if (idx !== -1 && idx > 0) {
                        // Remove and unshift to start
                        const el = this.currentCard.elements.splice(idx, 1)[0];
                        this.currentCard.elements.unshift(el);
                    }
                },

                // --- Styles & Rendering ---
                getElementStyle(el) {
                    const style = {
                        left: `${el.x}px`,
                        top: `${el.y}px`,
                        width: `${el.w}px`,
                        height: `${el.h}px`,
                        zIndex: el.z,
                    };
                    
                    if (el.type === 'shape') {
                        style.backgroundColor = el.color;
                        
                        switch(el.shapeType) {
                            case 'circle':
                                style.borderRadius = '50%';
                                break;
                            case 'triangle':
                                style.clipPath = 'polygon(50% 0%, 0% 100%, 100% 100%)';
                                break;
                            case 'triangle-inverted':
                                style.clipPath = 'polygon(50% 100%, 0% 0%, 100% 0%)';
                                break;
                            case 'star':
                                style.clipPath = 'polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%)';
                                break;
                            case 'hexagon':
                                style.clipPath = 'polygon(25% 0%, 75% 0%, 100% 50%, 75% 100%, 25% 100%, 0% 50%)';
                                break;
                            case 'heart':
                                style.clipPath = 'polygon(50% 85%, 100% 38%, 82% 0%, 50% 25%, 18% 0%, 0% 38%)'; 
                                break;
                            case 'rectangle':
                            default:
                                style.borderRadius = '0';
                                break;
                        }
                    }
                    
                    return style;
                },
                // --- SVG Shape Helpers for Print/Export ---
                getShapePoints(type) {
                    switch(type) {
                        case 'triangle':
                            return '50,0 0,100 100,100';
                        case 'triangle-inverted':
                            return '50,100 0,0 100,0';
                        case 'star':
                            return '50,0 61,35 98,35 68,57 79,91 50,70 21,91 32,57 2,35 39,35';
                        case 'hexagon':
                            return '25,0 75,0 100,50 75,100 25,100 0,50';
                        case 'heart':
                            return '50,85 100,38 82,0 50,25 18,0 0,38';
                        default:
                            return '';
                    }
                },

                // Conversion for Print (Px to approx mm ratio logic handled by CSS scale or Calc)
                // Current approach: Editor uses screenScale (3.8px per mm)
                // Print uses mm directly. So conversion is 1 / screenScale
                getPrintElementStyle(el) {
                    const scale = 1 / this.screenScale; // px to mm
                    
                    const style = {
                        left: `${el.x * scale}mm`,
                        top: `${el.y * scale}mm`,
                        width: `${el.w * scale}mm`,
                        height: `${el.h * scale}mm`,
                        zIndex: el.z,
                        position: 'absolute'
                    };

                    // Note: Background color and shape clipping are now handled by SVG in the template
                    // to ensure compatibility with html2canvas export.

                    return style;
                },
                scaleVal(val) {
                    // Font size scaling
                    // Screen: px
                    // Print: px (but inside a mm container?)
                    // If we output font-size in px inside a div sized in mm, browser treats px as 1/96 inch.
                    // Our screenScale is 3.8 px/mm.
                    // 1mm = 3.8 screen px.
                    // In print, 1mm is physical.
                    // If element has fontSize 16 (screen px), that is 16/3.8 = 4.2mm height.
                    // We need to output a value that renders as 4.2mm.
                    // In CSS print, 1mm = 3.78px.
                    // So we want (16 / 3.8) * 3.78 ~= 16.
                    // So actually, px value is roughly 1:1 if we ignore screen DPI differences.
                    // But previously we used val * (63/240) * 3.8.
                    // 63/240 = 1/3.8. So it was val * 1.
                    // So just returning val is fine?
                    // Let's keep it simple: scale down to mm then up to print px?
                    // No, simpler: 
                    // Editor pixel is arbitrary unit. 
                    // Let's say editor font 16px.
                    // Scale factor for position is 0.2625 (px -> mm).
                    // So font height is 16 * 0.2625 = 4.2mm.
                    // To display 4.2mm text in browser print (where 1px = 0.264mm),
                    // we need font-size: 4.2mm.
                    // But inline style usually expects px if no unit.
                    // Let's just output in mm? font-size: XX mm?
                    // But chrome minimum font size might block small values.
                    // Let's stick to the previous working formula which was roughly 1:1
                    return val * (1 / 3.8) * 3.8; // = val
                },

                // --- Drag & Drop Logic ---
                startDrag(event, element) {
                    if(this.currentView !== 'editor') return;
                    this.selectedElementId = element.id;
                    this.draggingElementId = element.id;
                    
                    // Handle Touch or Mouse
                    const clientX = event.touches ? event.touches[0].clientX : event.clientX;
                    const clientY = event.touches ? event.touches[0].clientY : event.clientY;

                    // Calculate offset
                    this.dragOffset.x = clientX - element.x;
                    this.dragOffset.y = clientY - element.y;
                },
                onMouseMove(event) {
                    if (this.draggingElementId) {
                        // Prevent scrolling on touch
                        if (event.touches) {
                            // event.preventDefault(); // Might block scrolling of the page? Only do this if we are sure.
                            // Better not preventDefault on window level unless necessary.
                            // But for dragging, we usually want to prevent scroll.
                        }

                        const el = this.currentCard.elements.find(e => e.id === this.draggingElementId);
                        if (el) {
                            const clientX = event.touches ? event.touches[0].clientX : event.clientX;
                            const clientY = event.touches ? event.touches[0].clientY : event.clientY;

                            // Snap to grid could be added here
                            el.x = clientX - this.dragOffset.x;
                            el.y = clientY - this.dragOffset.y;
                        }
                    }
                },
                onMouseUp() {
                    this.draggingElementId = null;
                },

                // --- Card Types Logic ---
                saveAsType(target) {
                    if (!this.newTypeName) {
                        this.saveMessage = 'âŒ è«‹è¼¸å…¥ç‰ˆå‹åç¨±';
                        this.saveMessageType = 'error';
                        setTimeout(() => { this.saveMessage = ''; }, 2000);
                        return;
                    }
                    // Deep copy elements
                    const layoutElements = JSON.parse(JSON.stringify(this.currentCard.elements));
                    
                    // Assign new IDs for the template but keep content
                    layoutElements.forEach(el => {
                        el.id = this.uuid(); 
                    });

                    const newType = {
                        id: this.uuid(),
                        name: this.newTypeName,
                        elements: layoutElements,
                        bgColor: this.currentCard.bgColor,
                        borderColor: this.currentCard.borderColor,
                        borderWidth: this.currentCard.borderWidth,
                        // New properties
                        width: this.currentCard.width || 63,
                        height: this.currentCard.height || 88,
                        sourceProject: this.currentProject.name
                    };

                    if (target === 'global') {
                        this.globalLibrary.push(newType);
                    } else {
                        this.currentProject.localTypes.push(newType);
                    }
                    
                    this.newTypeName = '';
                    // alert("ç‰ˆå‹å·²å„²å­˜ï¼"); // Removed alert
                    this.saveMessage = 'âœ… ç‰ˆå‹å·²å„²å­˜ï¼';
                    this.saveMessageType = 'success';
                    setTimeout(() => {
                        this.saveMessage = '';
                    }, 2000);
                },
                applyCardType(type) {
                    if (!confirm("å¥—ç”¨ç‰ˆå‹å°‡è¦†è“‹ç›®å‰çš„å¡ç‰‡å…§å®¹ï¼Œç¢ºå®šå—ï¼Ÿ")) return;
                    
                    // Deep copy elements from type to current card
                    const newElements = JSON.parse(JSON.stringify(type.elements));
                    
                    // Assign new IDs so they are unique instances
                    newElements.forEach(el => el.id = this.uuid());
                    
                    this.currentCard.elements = newElements;
                    
                    // Apply card properties from type (with defaults for old types)
                    this.currentCard.bgColor = type.bgColor || '#ffffff';
                    this.currentCard.borderColor = type.borderColor || '#000000';
                    this.currentCard.borderWidth = type.borderWidth !== undefined ? type.borderWidth : 0;
                    
                    // Apply dimensions if present
                    if (type.width) this.currentCard.width = type.width;
                    if (type.height) this.currentCard.height = type.height;
                },
                deleteGlobalType(index) {
                    if(confirm("ç¢ºå®šåˆªé™¤æ­¤å…¨åŸŸç‰ˆå‹ï¼Ÿ")) {
                        this.globalLibrary.splice(index, 1);
                    }
                },
                deleteLocalType(index) {
                    if(confirm("ç¢ºå®šåˆªé™¤æ­¤å°ˆæ¡ˆç‰ˆå‹ï¼Ÿ")) {
                        this.currentProject.localTypes.splice(index, 1);
                    }
                },

                // --- Print ---
                onQuantityChange(id, value) {
                    const val = parseInt(value);
                    if (!isNaN(val) && val > 0) {
                        if (!this.printSelection.includes(id)) {
                            this.printSelection.push(id);
                        }
                    } else {
                        // If 0 or empty, uncheck
                        if (this.printSelection.includes(id)) {
                            this.printSelection = this.printSelection.filter(i => i !== id);
                        }
                    }
                },
                ensureQuantity(id) {
                    if (this.printSelection.includes(id)) {
                        if (!this.printQuantities[id] || this.printQuantities[id] < 1) {
                            this.printQuantities[id] = 1;
                        }
                    }
                },
                toggleSelectAll() {
                    if (this.printSelection.length === this.currentProject.cards.length) {
                        this.printSelection = [];
                    } else {
                        this.printSelection = this.currentProject.cards.map(c => c.id);
                        // Ensure all have quantity 1 if not set
                        this.printSelection.forEach(id => {
                            if (!this.printQuantities[id]) this.printQuantities[id] = 1;
                        });
                    }
                },
                async exportToPng() {
                    if (this.printableCards.length === 0) {
                        this.exportMessage = 'âŒ è«‹å…ˆé¸æ“‡è‡³å°‘ä¸€å¼µè¦è¼¸å‡ºçš„å¡ç‰‡';
                        setTimeout(() => { this.exportMessage = ''; }, 2000);
                        return;
                    }

                    this.isExporting = true;
                    this.exportProgress = 'æº–å‚™ä¸­...';

                    // Wait for DOM to be ready just in case
                    await this.$nextTick();
                    
                    const pages = document.querySelectorAll('.print-page');
                    const total = pages.length;
                    
                    if (total === 0) {
                        alert("æ‰¾ä¸åˆ°é è¦½é é¢ï¼Œè«‹é‡æ–°æ•´ç†è©¦è©¦");
                        this.isExporting = false;
                        return;
                    }

                    try {
                        // Create a container for clean rendering (off-screen/isolated)
                        const container = document.createElement('div');
                        container.style.position = 'fixed';
                        container.style.top = '0';
                        container.style.left = '0';
                        // Use z-index to hide it behind everything but ensure it's rendered in DOM
                        container.style.zIndex = '-9999'; 
                        // Ensure container doesn't constrain width
                        container.style.width = 'auto';
                        container.style.height = 'auto';
                        document.body.appendChild(container);

                        for (let i = 0; i < total; i++) {
                            this.exportProgress = `${i + 1} / ${total}`;
                            const originalPage = pages[i];
                            
                            // Clone the page to isolate from view scaling/transforms
                            const clone = originalPage.cloneNode(true);
                            
                            // Force reset styles on the clone to ensure clean A4 layout
                            // We use !important to override any Tailwind utility classes
                            clone.style.setProperty('transform', 'none', 'important');
                            clone.style.setProperty('margin', '0', 'important');
                            clone.style.setProperty('box-shadow', 'none', 'important');
                            // Ensure it's positioned relative within our container
                            clone.style.setProperty('position', 'absolute', 'important');
                            clone.style.setProperty('top', '0', 'important');
                            clone.style.setProperty('left', '0', 'important');
                            
                            // Append clone to container
                            container.innerHTML = '';
                            container.appendChild(clone);
                            
                            // Small delay to allow layout to settle
                            await new Promise(resolve => setTimeout(resolve, 50));

                            // Calculate scale for 300 PPI (A4 width 2480px)
                            // The clone is sized in mm (210mm). In DOM (96dpi), that's approx 793px.
                            const originalWidth = clone.offsetWidth || 793;
                            const targetWidth = 2480;
                            const scaleFactor = targetWidth / originalWidth;

                            const canvas = await html2canvas(clone, {
                                scale: scaleFactor, 
                                backgroundColor: '#ffffff',
                                useCORS: true, 
                                logging: false,
                                scrollX: 0,
                                scrollY: 0
                            });

                            // Download
                            const link = document.createElement('a');
                            link.download = `${this.currentProject.name}-page-${i + 1}.png`;
                            link.href = canvas.toDataURL('image/png');
                            link.click();
                        }
                        
                        // Cleanup
                        document.body.removeChild(container);

                    } catch (err) {
                        console.error(err);
                        alert("åœ–ç‰‡åŒ¯å‡ºå¤±æ•—: " + err.message);
                    } finally {
                        this.isExporting = false;
                        this.exportProgress = '';
                    }
                },

                // --- Persistence ---
                saveData() {
                    const data = {
                        projects: this.projects,
                        globalLibrary: this.globalLibrary
                    };
                    localStorage.setItem('cardMakerData', JSON.stringify(data));
                },
                loadData() {
                    const saved = localStorage.getItem('cardMakerData');
                    if (saved) {
                        try {
                            const parsed = JSON.parse(saved);
                            this.projects = parsed.projects || [];
                            this.globalLibrary = parsed.globalLibrary || [];
                        } catch(e) {
                            console.error("Load failed", e);
                        }
                    }
                },
                exportData() {
                    const dataStr = JSON.stringify({
                        projects: this.projects,
                        globalLibrary: this.globalLibrary
                    });
                    const blob = new Blob([dataStr], {type: "application/json"});
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `card-maker-backup-${new Date().toISOString().slice(0,10)}.json`;
                    a.click();
                },
                importData(event) {
                    const file = event.target.files[0];
                    if (!file) return;
                    
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            const data = JSON.parse(e.target.result);
                            if (confirm("åŒ¯å…¥å°‡è¦†è“‹ç›®å‰æ‰€æœ‰è³‡æ–™ï¼Œç¢ºå®šå—ï¼Ÿ")) {
                                this.projects = data.projects || [];
                                this.globalLibrary = data.globalLibrary || [];
                                this.saveData();
                                this.currentView = 'projects';
                                this.currentProjectId = null;
                            }
                        } catch(err) {
                            alert("æª”æ¡ˆæ ¼å¼éŒ¯èª¤");
                        }
                    };
                    reader.readAsText(file);
                }
            }
        }).mount('#app');
    </script>
</body>
</html>

